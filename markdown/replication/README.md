# redis

## 副本

Redis采用主从模式进行数据备份，数据从server端复制给slave端，而salve端又可以成为别的slave端的server

在复制的过程中，主节点和从节点都是非阻塞的，从节点在复制的过程中收到了查询请求，那么会返回旧的数据集上的结果，但是一旦复制完成，从节点上旧的数据集会被删除，新的数据需要被装载，这个时候从节点内部会发生阻塞

有一种比较危险的配置，主节点不将数据写到磁盘上，而是通过从节点不断的复制这些数据，这样可以提高性能，但是如果主节点宕机，保存在内存中的数据就都没有了，这个时候，别的从节点再去复制，自身的数据也会被清理掉

## 数据复制

从节点在复制主节点的数据的时候有两种情况

### 全数据复制

主节点启动一个后台进程了产生RDB文件，同时将保存在所有内存中的写命令缓存起来，当RDB文件产生完成之后，主节点将数据发送到从节点上，从节点先把数据保存在磁盘上，再装载到内存中，这一步完成之后，主节点再把所有缓存的命令发送给从节点

在2.8.18版本之后，支持将RDB文件直接发给从节点而不是写磁盘

### 部分数据复制

当从节点不需要将所有的数据复制过来的时候，可以采用部分同步的机制。

主节点再内存中创建一个backlog，保存当前所有的修改操作，从节点在复制的时候所需要的数据根据主节点的运行ID和偏移值来确定，ID能对应的上，就按偏移值传送数据，对不上，就只能复制全数据集


## 只读节点

从节点默认是只接受读请求的，它会拒绝所有写命令。从节点也是可以配置接受写请求的，当时这种写请求是自己本地的，不会复制给它的下级

> A ---> B ---> C

加入B是可以写的，但是C看不到B上的更改，他只会看到A上的变化


## 有N个从节点同步的情况下写

可以配置当主节点再有N个从节点处于同步的状态下，才允许写请求。从节点每秒ping一次主节点，主节点记录有多少个从节点处于同步中，可以配置一个超时时间

但是不管怎么说，上面的做法无法保证数据的强一致性，在一个可控的时间窗口内，会出现数据不一致的情况


## 对副本过期key的处理

由于不能做到主节点和从节点的时钟同步，所以从节点自身不决定一个key是否过期，它只会等待主节点那里同步过来的信息，如果不能及时等到，就用自己的逻辑时钟来判断。针对一个读请求，用逻辑时钟返回key不存在
